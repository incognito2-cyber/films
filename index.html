<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TextCrypt</title>
<meta name="theme-color" content="#121212" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon.png" />
<style>
  body {
    margin: 0; padding: 20px;
    font-family: sans-serif;
    background-color: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  textarea, input[type=text], input[type=file] {
    width: 100%; max-width: 600px;
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: none;
    background: #222;
    color: #eee;
    font-size: 1rem;
    resize: vertical;
  }
  button {
    background: #444;
    border: none;
    color: white;
    padding: 12px 20px;
    margin: 6px 4px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover {
    background: #666;
  }
  .btn-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 600px;
  }
  #qr-container, #qr-reader {
    margin-top: 15px;
  }
  #qr-reader {
    width: 300px;
    display: none;
  }
  .theme-toggle {
    margin-top: 10px;
    cursor: pointer;
    user-select: none;
  }
</style>
</head>
<body>

<h1>TextCrypt üîê</h1>

<input id="password" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="on" />

<textarea id="input" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"></textarea>

<div class="btn-row">
  <button onclick="encryptText()">üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="decryptText()">üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<textarea id="output" rows="4" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç..." readonly></textarea>

<div class="btn-row">
  <button onclick="copyResult()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
  <button onclick="generateQR()">üì∑ –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</button>
  <button onclick="scanQR()">üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
</div>

<div id="qr-container"></div>
<div id="qr-reader"></div>

<div class="btn-row" style="margin-top: 20px;">
  <input id="fileInput" type="file" accept=".txt" />
  <button onclick="encryptFile()">üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</button>
  <button onclick="decryptFile()">üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</button>
</div>

<div class="theme-toggle" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåó –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</div>

<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  // –¢–µ–º–∞
  let dark = localStorage.getItem('theme') !== 'light';
  applyTheme();
  function toggleTheme() {
    dark = !dark;
    localStorage.setItem('theme', dark ? 'dark' : 'light');
    applyTheme();
  }
  function applyTheme() {
    if (dark) {
      document.body.style.backgroundColor = '#121212';
      document.body.style.color = '#eee';
    } else {
      document.body.style.backgroundColor = '#fff';
      document.body.style.color = '#111';
    }
  }

  // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
  function encryptText() {
    const text = document.getElementById("input").value;
    const pass = document.getElementById("password").value;
    if (!text || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –ø–∞—Ä–æ–ª—å");
    const salt = CryptoJS.enc.Hex.parse("a1b2c3d4e5f6");
    const key = CryptoJS.PBKDF2(pass, salt, { keySize: 32 / 4, iterations: 1000 });
    const iv = CryptoJS.lib.WordArray.random(12);
    const encrypted = CryptoJS.AES.encrypt(text, key, {
      iv: iv,
      mode: CryptoJS.mode.GCM,
      format: CryptoJS.format.OpenSSL
    });
    const result = iv.toString() + encrypted.toString();
    document.getElementById("output").value = result;
    generateQR();
  }

  // –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
  function decryptText() {
    const data = document.getElementById("output").value;
    const pass = document.getElementById("password").value;
    if (!data || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –ø–∞—Ä–æ–ª—å");
    try {
      const salt = CryptoJS.enc.Hex.parse("a1b2c3d4e5f6");
      const key = CryptoJS.PBKDF2(pass, salt, { keySize: 32 / 4, iterations: 1000 });
      const iv = CryptoJS.enc.Hex.parse(data.slice(0, 24));
      const encrypted = data.slice(24);
      const decrypted = CryptoJS.AES.decrypt(encrypted, key, {
        iv: iv,
        mode: CryptoJS.mode.GCM,
        format: CryptoJS.format.OpenSSL
      });
      const decoded = decrypted.toString(CryptoJS.enc.Utf8);
      if (!decoded) throw new Error();
      document.getElementById("input").value = decoded;
    } catch {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç");
    }
  }

  // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
  function clearAll() {
    document.getElementById("input").value = "";
    document.getElementById("output").value = "";
  }

  // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  function copyResult() {
    const out = document.getElementById("output");
    if (!out.value) return alert("–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
    navigator.clipboard.writeText(out.value).then(() => {
      alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
    });
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR
  function generateQR() {
    const text = document.getElementById("output").value;
    if (!text) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞—à–∏—Ñ—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç");
    const container = document.getElementById("qr-container");
    container.innerHTML = "";
    QRCode.toCanvas(text, { width: 200 }, (err, canvas) => {
      if (err) console.error(err);
      container.appendChild(canvas);
    });
  }

  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR
  function scanQR() {
    const qrReader = document.getElementById("qr-reader");
    qrReader.style.display = "block";

    const html5QrCode = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const cameraId = devices[0].id;
        html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          qrMessage => {
            document.getElementById("output").value = qrMessage;
            qrReader.style.display = "none";
            html5QrCode.stop();
            alert("QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å—á–∏—Ç–∞–Ω");
          },
          err => {}
        );
      }
    }).catch(err => alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err));
  }

  // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
  function encryptFile() {
    const fileInput = document.getElementById("fileInput");
    const pass = document.getElementById("password").value;
    if (!fileInput.files.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
    if (!pass) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const content = e.target.result;
      const salt = CryptoJS.enc.Hex.parse("a1b2c3d4e5f6");
      const key = CryptoJS.PBKDF2(pass, salt, { keySize: 32 / 4, iterations: 1000 });
      const iv = CryptoJS.lib.WordArray.random(12);
      const encrypted = CryptoJS.AES.encrypt(content, key, {
        iv: iv,
        mode: CryptoJS.mode.GCM,
        format: CryptoJS.format.OpenSSL
      });
      const result = iv.toString() + encrypted.toString();
      downloadFile("encrypted.txt", result);
    };
    reader.readAsText(file);
  }

  // –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞
  function decryptFile() {
    const fileInput = document.getElementById("fileInput");
    const pass = document.getElementById("password").value;
    if (!fileInput.files.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
    if (!pass) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const data = e.target.result;
      try {
        const salt = CryptoJS.enc.Hex.parse("a1b2c3d4e5f6");
        const key = CryptoJS.PBKDF2(pass, salt, { keySize: 32 / 4, iterations: 1000 });
        const iv = CryptoJS.enc.Hex.parse(data.slice(0, 24));
        const encrypted = data.slice(24);
        const decrypted = CryptoJS.AES.decrypt(encrypted, key, {
          iv: iv,
          mode: CryptoJS.mode.GCM,
          format: CryptoJS.format.OpenSSL
        });
        const decoded = decrypted.toString(CryptoJS.enc.Utf8);
        if (!decoded) throw new Error();
        downloadFile("decrypted.txt", decoded);
      } catch {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π —Ñ–∞–π–ª");
      }
    };
    reader.readAsText(file);
  }

  // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
  function downloadFile(filename, content) {
    const a = document.createElement("a");
    const blob = new Blob([content], { type: "text/plain" });
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

</body>
</html>
