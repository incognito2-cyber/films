<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TextCrypt</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212" />
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    textarea, input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      background: #1e1e1e;
      color: white;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    #qr-container {
      margin-top: 10px;
    }
    #qr-reader {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>TextCrypt üîê</h2>

  <textarea id="input" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea><br />
  <input id="password" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" /><br />

  <button onclick="encrypt()">üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="decrypt()">üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyOutput()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="generateQR()">üì∑ QR-–∫–æ–¥</button>
  <button onclick="scanQR()">üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>

  <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
  <textarea id="output" rows="4" readonly></textarea>
  <div id="qr-container"></div>
  <div id="qr-reader" style="display:none; width: 250px;"></div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    function encrypt() {
      const text = document.getElementById("input").value;
      const pass = document.getElementById("password").value;
      if (!text || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –∏ —Ç–µ–∫—Å—Ç, –∏ –ø–∞—Ä–æ–ª—å");
      const encrypted = CryptoJS.AES.encrypt(text, pass).toString();
      document.getElementById("output").value = encrypted;
      generateQR(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å QR
    }

    function decrypt() {
      const text = document.getElementById("input").value;
      const pass = document.getElementById("password").value;
      if (!text || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –∏ —Ç–µ–∫—Å—Ç, –∏ –ø–∞—Ä–æ–ª—å");
      try {
        const decrypted = CryptoJS.AES.decrypt(text, pass).toString(CryptoJS.enc.Utf8);
        document.getElementById("output").value = decrypted || "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
      } catch {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–µ");
      }
    }

    function copyOutput() {
      const out = document.getElementById("output");
      if (!out.value) return;
      navigator.clipboard.writeText(out.value);
      alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
    }

    function generateQR() {
      const text = document.getElementById("output").value;
      if (!text) return;
      const container = document.getElementById("qr-container");
      container.innerHTML = "";
      QRCode.toCanvas(text, { width: 200 }, function (err, canvas) {
        if (err) console.error(err);
        container.appendChild(canvas);
        container.style.display = "block";
      });
    }

    function scanQR() {
      const reader = document.getElementById("qr-reader");
      reader.style.display = "block";
      const html5QrCode = new Html5Qrcode("qr-reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrMessage => {
              document.getElementById("input").value = qrMessage;
              html5QrCode.stop();
              reader.style.display = "none";
              alert("QR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω!");
            },
            err => {}
          );
        }
      }).catch(err => alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err));
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service-worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
